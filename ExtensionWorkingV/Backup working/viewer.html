<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UI</title>
  <style>
    body {
      margin: 0;
      height: 100vh;
      font-family: 'Georgia', serif;
      background: url('./main-bg.jpg') no-repeat center center / cover;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
	
	.stats-section div {
  display: flex;
  justify-content: space-between;
  width: 100%;
  padding: 0.25rem 0;
}

	
	
    .layout {
      display: grid;
      grid-template-columns: 300px 400px;
      grid-template-rows: auto auto;
      gap: 1rem;
      background: url('./container-bg.jpg') no-repeat center center / cover;
      padding: 2rem;
      border-radius: 0px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .avatar-section, .stats-section, .info-section, .level-section {
      background: url('./section-bg.jpg') no-repeat center center / cover;
      padding: 1rem;
      border-radius: 0px;
      box-shadow: 0 0 5px rgba(0,0,0,0.5);
      color: white;
      font-size: calc(10px + 0.8vw);
    }
    .avatar {
      width: 100%;
      height: auto;
      object-fit: cover;
      box-shadow: 0 4px 10px rgba(0,0,0,0.7);
    }
    .sidebar, .settings {
      width: 250px;
      background: #d4c4a8;
      overflow-y: auto;
      padding: 1rem;
      border-right: 2px solid #555;
      display: none;
      flex-direction: column;
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
    }
    .settings {
      left: auto;
      right: 0;
    }
    #raceList li {
      cursor: pointer;
      margin: 0.5rem 0;
      font-weight: bold;
    }
    .top-bar {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #ccc;
      padding: 0.5rem;
      cursor: pointer;
      font-size: 1.5rem;
      border-radius: 0px;
      z-index: 1000;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .modal-content {
      background: #333;
      padding: 2rem;
      border-radius: 0px;
      max-width: 90%;
      max-height: 80%;
      overflow-y: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
    }
    .modal-content img {
      width: 150px;
      height: 150px;
      object-fit: cover;
      cursor: pointer;
      border-radius: 0px;
      box-shadow: 0 0 5px rgba(255,255,255,0.7);
      transition: transform 0.2s;
    }
    .modal-content img:hover {
      transform: scale(1.05);
    }
    .warning {
      background: #ffd2d2;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border: 2px solid red;
      border-radius: 0px;
      position: relative;
    }
    .warning button {
      position: absolute;
      top: 2px;
      right: 5px;
      background: none;
      border: none;
      font-size: 1rem;
      cursor: pointer;
    }
    button {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div class="sidebar" id="avatarSidebar">
  <h2>Select Race</h2>
  <ul id="raceList"></ul>
</div>

<div class="layout">
  <div class="avatar-section">
    <img id="avatar" class="avatar" src="" style="display:none;">
    <button onclick="openAvatarSelection()">Change Avatar</button>
  </div>
  <div class="stats-section" id="stats"></div>
  <div class="info-section" id="info"></div>
  <div class="level-section" id="level"></div>
</div>

<div class="settings" id="settingsSidebar">
  <h2>Settings</h2>
  <button onclick="saveCharacter()">Save Character</button>
  <h3>Load Characters</h3>
  <div id="loadList"></div>
  <button onclick="newCharacter()">New Character</button>
</div>

<div class="top-bar" onclick="toggleSettings()">â‰¡</div>

<div class="modal" id="avatarModal">
  <div class="modal-content" id="avatarSelection"></div>
</div>

<script>
const races = [
  'drow', 'duegar', 'dwarf', 'elf', 'fiends',
  'giths', 'gnome', 'goblin', 'halfling', 'half-orc',
  'hobgoblin', 'human', 'illithid', 'legends', 'ogre',
  'orc', 'Other', 'undead'
];

function getParams() {
  const params = new URLSearchParams(window.location.search);
  const cleanedParams = {};
  for (const [key, value] of params.entries()) {
    cleanedParams[key] = value.replace(/-+$/, '').replace(/_/g, ' '); // Remove trailing dashes and replace underscores
  }
  return cleanedParams;
}



function loadRaces() {
  const list = document.getElementById('raceList');
  races.forEach(race => {
    const li = document.createElement('li');
    li.textContent = race.charAt(0).toUpperCase() + race.slice(1);
    li.addEventListener('click', () => loadAvatars(race));
    list.appendChild(li);
  });
}

function loadAvatars(race) {
  const modal = document.getElementById('avatarModal');
  const container = document.getElementById('avatarSelection');
  container.innerHTML = '';
  let index = 1;
  let foundOne = false;

  function tryLoad() {
    const img = document.createElement('img');
    img.src = `avatars/${race}/${index}.jpg`;
    img.onload = () => {
      img.addEventListener('click', () => {
        localStorage.setItem('selectedAvatar', img.src);
        const avatar = document.getElementById('avatar');
        avatar.src = img.src;
        avatar.style.display = 'inline';
        modal.style.display = 'none';
      });
      container.appendChild(img);
      foundOne = true;
      index++;
      tryLoad();
    };
    img.onerror = () => {
      if (!foundOne) {
        container.innerHTML = '<p style="color: white;">No avatars found for this race.</p>';
      }
    };
  }

  modal.style.display = 'flex';
  tryLoad();
}

function openAvatarSelection() {
  document.getElementById('avatarSidebar').style.display = 'flex';
}

function toggleSettings() {
  const settings = document.getElementById('settingsSidebar');
  settings.style.display = settings.style.display === 'flex' ? 'none' : 'flex';
}

function renderCharacter() {
  const data = getParams();
  const stats = ['str','dex','con','int','wis','cha'];
  const statsContainer = document.getElementById('stats');
  const infoContainer = document.getElementById('info');
  const levelContainer = document.getElementById('level');

  statsContainer.innerHTML = '';
  infoContainer.innerHTML = '';
  levelContainer.innerHTML = '';

  stats.forEach(stat => {
    if (data[stat]) {
      statsContainer.innerHTML += `<div>${stat.toUpperCase()}: ${data[stat]}</div>`;
	
    }
  });

  if (data.name) infoContainer.innerHTML += `<div>Name: ${data.name}</div>`;
  if (data.race) infoContainer.innerHTML += `<div>Race: ${data.race}</div>`;
  if (data.class) infoContainer.innerHTML += `<div>Class: ${data.class}</div>`;
  if (data.alignment) infoContainer.innerHTML += `<div>Alignment: ${data.alignment}</div>`;


  if (data.level) levelContainer.innerHTML += `<div>Level: ${data.level}</div>`;
  if (data.exp) levelContainer.innerHTML += `<div>XP: ${data.exp}</div>`;
  if (data.hp) levelContainer.innerHTML += `<div>HP: ${data.hp}</div>`;

  const savedAvatar = localStorage.getItem('selectedAvatar');
  if (savedAvatar) {
    const avatar = document.getElementById('avatar');
    avatar.src = savedAvatar;
    avatar.style.display = 'inline';
	
document.getElementById('stats').style.fontSize = 'calc(14px + 1.3vw)';

  }
}

function saveCharacter() {
  const saveName = prompt('Name your character save:');
  if (!saveName) return;
  const data = getParams();
  data.avatar = document.getElementById('avatar').src;
  let saves = JSON.parse(localStorage.getItem('character_saves') || '{}');
  saves[saveName] = data;
  localStorage.setItem('character_saves', JSON.stringify(saves));
  loadSavedCharacters();
}

function loadSavedCharacters() {
  const container = document.getElementById('loadList');
  container.innerHTML = '';
  let saves = JSON.parse(localStorage.getItem('character_saves') || '{}');
  for (let name in saves) {
    const div = document.createElement('div');
    div.textContent = name;
    div.addEventListener('click', () => {
      const savedData = saves[name];
      if (savedData.avatar) {
        localStorage.setItem('selectedAvatar', savedData.avatar);
      }
      const params = new URLSearchParams(savedData).toString();
      window.location.search = params;
    });
    container.appendChild(div);
  }
}

function newCharacter() {
  if (confirm('Start a new character?')) {
    localStorage.removeItem('selectedAvatar');
    window.location.href = window.location.pathname;
  }
}

function initialAvatarCheck() {
  if (!localStorage.getItem('selectedAvatar')) {
    document.getElementById('avatarSidebar').style.display = 'flex';
  }
}

// --- D20 Roller ---
let currentRollConfig = { adv: false, mod: 0, dc: null, check: '' };

function getRollValue() {
  return Math.floor(Math.random() * 20) + 1;
}

function rollD20(config = currentRollConfig) {
  const { adv, mod, dc, check } = config;
  currentRollConfig = { adv, mod, dc, check }; // Store last config for reroll

  const numberDiv = document.getElementById('rollerDiceNumber');
  const totalDiv = document.getElementById('rollerTotal');
  const dcDiv = document.getElementById('rollerDC');
  const modDiv = document.getElementById('rollerMod');
  const checkOverlay = document.getElementById('rollerCheckOverlay');
  const resultImg = document.getElementById('rollerResultImage');
  const die = document.querySelector('.roller-dice-textured');

  numberDiv.classList.remove('natural20');
  die.classList.remove('natural20');
  resultImg.src = '';
  resultImg.style.display = 'none';
  totalDiv.textContent = '';

  modDiv.textContent = `Modifier: ${mod >= 0 ? '+' : ''}${mod}`;
  dcDiv.textContent = dc !== null ? `DC: ${dc}` : '';
  checkOverlay.textContent = check
    ? `${check.charAt(0).toUpperCase() + check.slice(1)}`
    : 'Skill Check';

  let roll1 = getRollValue();
  let roll2 = adv ? getRollValue() : null;
  let baseRoll = adv ? Math.max(roll1, roll2) : roll1;
  let finalRoll = baseRoll + mod;

  let step = 0;
  const interval = setInterval(() => {
    const tempRoll = getRollValue();
    numberDiv.textContent = tempRoll;
    step++;
    if (step > 15) {
      clearInterval(interval);
      numberDiv.textContent = baseRoll;
      totalDiv.textContent = `Total: ${baseRoll} ${mod >= 0 ? '+' : ''}${mod} = ${finalRoll}`;

      if (baseRoll === 20) {
        numberDiv.classList.add('natural20');
        die.classList.add('natural20');
      }

      const passed = dc !== null ? finalRoll >= dc : null;
      if (passed !== null) {
        resultImg.src = passed
          ? 'dice-assets/SUCCESS.png'
          : 'dice-assets/FAILURE.png';
        resultImg.style.display = 'block';
      }
    }
  }, 100);
}

function toggleRoller() {
  document.getElementById('rollerModal').style.display = 'flex';

  const params = getParams();
  const adv = params.adv === "true";
  const mod = parseInt(params.mod || "0");
  const dc = params.dc ? parseInt(params.dc) : null;
  const check = params.check || '';

  rollD20({ adv, mod, dc, check });
}

function closeRoller() {
  document.getElementById('rollerModal').style.display = 'none';
}

function handleRollFromURL() {
  const params = getParams();
  if (!params.roll || !params.roll.includes("d20")) return;

  document.getElementById("rollerModal").style.display = "flex";

  const adv = params.adv === "true";
  const mod = parseInt(params.mod || "0");
  const dc = params.dc ? parseInt(params.dc) : null;
  const check = params.check || '';

  rollD20({ adv, mod, dc, check });
}

window.addEventListener("load", () => {
  loadRaces();
  renderCharacter();
  loadSavedCharacters();
  initialAvatarCheck();
  handleRollFromURL();
});
</script>

<!-- ðŸŽ² Floating Dice Button -->
<div class="top-bar" style="right: 60px;" onclick="toggleRoller()">ðŸŽ²</div>

<!-- ðŸŽ² Fullscreen D20 Roller Modal -->
<div class="modal" id="rollerModal">
  <div class="roller-bg">

    <!-- Fixed Top Section -->
    <div class="roller-fixed-top">
      <div class="roller-check-overlay" id="rollerCheckOverlay">Skill Check</div>
      <img src="dice-assets/skill-banner.png" class="roller-banner" />
      <div id="rollerDC" class="roller-dc">DC: </div>
    </div>

    <!-- Die and Number -->
    <div class="roller-dice-textured" onclick="rollD20(currentRollConfig)">
      <img src="dice-assets/dice-frame.png" class="roller-dice-bg" />
      <div class="roller-dice-number" id="rollerDiceNumber">?</div>
    </div>

    <!-- Modifier Total -->
    <div id="rollerTotal" class="roller-total"></div>

    <!-- Modifier Display -->
    <div class="roller-mod-wrap">
      <img src="dice-assets/modifier-box.png" class="roller-mod-box" />
      <div id="rollerMod" class="roller-mod-value">Modifier: +0</div>
    </div>

    <!-- Success/Failure -->
    <img id="rollerResultImage" class="roller-result-img" src="" style="display:none;" />

    <!-- Close Button -->
    <img src="dice-assets/continue-button.png" onclick="closeRoller()" class="roller-close-btn" />
  </div>
</div>

<!-- ðŸŽ¨ Modal Styles -->
<style>
#rollerModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  z-index: 9999;
  justify-content: center;
  align-items: start;
  padding: 0;
}

.roller-bg {
  position: relative;
  width: 90vw;
  max-width: 600px;
  height: 100vh;
  background: url('dice-assets/roller-bg.png') no-repeat center center / cover;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: start;
  padding: 2rem;
  box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
  overflow: hidden;
}


.roller-bg::before,
.roller-bg::after {
  content: "";
  position: absolute;
  top: 0;
  width: 10px; /* width of bar */
  height: 100%;
  background: white; /* default solid white */
  z-index: 1;
  opacity: 0.9;
  pointer-events: none;
}

/* Left bar */
.roller-bg::before {
  left: 15px;
}

/* Right bar */
.roller-bg::after {
  right: 15px;
}


.roller-fixed-top {
  position: relative;
  text-align: center;
  margin-bottom: 1rem;
}

.roller-banner {
  width: 600px;
  display: block;
  margin: 0 auto;
}

.roller-check-overlay {
  position: absolute;
  top: 15px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 3.2rem;
  font-weight: bold;
  color: white;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
  pointer-events: none;
  z-index: 2;
}

.roller-dc {
  font-size: 1.5rem;
  color: white;
  margin-top: 0.25rem;
}

.roller-dice-textured {
  position: relative;
  width: clamp(160px, 25vw, 300px);
  height: clamp(160px, 25vw, 300px);
  margin: 1rem 0;
  transition: transform 0.3s ease;
  cursor: pointer;
}


.roller-dice-bg {
  display: block;
  margin: 0 auto;
  width: 100%;
  height: 100%;
  object-fit: contain;
 

}

.roller-dice-number {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: clamp(2rem, 6vw, 5rem);
  font-weight: bold;
  color: black;
  text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.7);
  font-family: 'Garamond';
  transition: transform 0.3s ease, font-size 0.3s ease;
}

.roller-dice-textured.natural20 {
  transform: scale(1.3);
}

.roller-dice-number.natural20 {
  font-size: clamp(3rem, 8vw, 6rem);
  color: #ffd700;
}

.roller-total {
  color: white;
  font-size: 1.2rem;
  margin-bottom: 1rem;
}

.roller-mod-wrap {
  position: relative;
  margin-top: 1rem;
}

.roller-mod-box {
  width: 260px;
}

.roller-mod-value {
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  color: white;
  font-size: 1.4rem;
  font-weight: bold;
  padding-top: 0.5rem;
  text-align: center;
}

.roller-result-img {
  width: 200px;
  margin-top: 1.5rem;
}

.roller-close-btn {
  width: 200px;
  margin-top: 1.5rem;
  cursor: pointer;
}
</style>

